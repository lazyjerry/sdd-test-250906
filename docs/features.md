# 功能特色

## 主要功能

### 角色基礎註冊系統

- **普通註冊** (`POST /api/v1/auth/register`): 任何人可註冊為 `user` 角色
- **管理員註冊** (`POST /api/v1/admin/register`): 管理員可創建任何角色的用戶
- **統一用戶創建** (`POST /api/v1/admin/users`): 管理員使用統一 API 創建用戶
- **角色權限隔離**: 嚴格的權限控制，確保安全性

### 統一登入體驗

- **智能識別**: 系統自動判斷輸入的是 username 還是 email，無需用戶區分
- **一致性體驗**: `/api/v1/auth/login` 和 `/api/v1/auth/admin-login` 都支援相同的登入方式
- **向下相容**: 保持原有 API 結構，新功能完全向下相容
- **角色隔離**: 確保用戶和管理員無法互通使用對方的登入 API

### 統一用戶管理

- **單一 User Table**: 使用單一 User Table 管理所有用戶類型，透過角色區分權限
- **預設管理員系統**: 系統自動創建預設管理員，支援管理員創建其他管理員
- **靈活登入方式**: 所有用戶都支援 username 或 email 登入，無需區分身份類型

### JWT Token 認證

- **Laravel Sanctum**: 提供安全的 API 認證
- **Token 過期**: 24 小時自動過期
- **角色隔離**: 不同角色使用不同的登入端點

### 密碼重設與郵箱驗證

- **完整的帳戶安全機制**: 密碼重設流程
- **可配置郵箱驗證**: 透過環境變數控制是否需要 email 驗證
- **管理員免驗證**: 管理員登入不受 email 驗證設定影響

### 個人資料管理

- **完整的用戶個人資料 CRUD 操作**
- **安全的密碼變更流程**
- **用戶資料驗證機制**

### 管理員使用者管理

- **全面的用戶管理功能**: 查看、編輯、刪除、角色管理
- **用戶搜尋與過濾**: 支援分頁、搜尋、角色過濾
- **批量操作**: 支援批量用戶管理操作
- **審計日誌**: 管理員操作記錄

### API 速率限制與安全防護

- **防止濫用和攻擊**: 登入 5 次失敗後鎖定 5 分鐘
- **CORS 支援**: 跨域請求處理
- **安全標頭**: 完整的安全標頭配置

### 完整 API 文件與測試

- **Insomnia 集合**: 完整的 API 測試集合
- **Swagger UI**: 詳細的 API 文檔
- **詳細測試套件**: 170+ 自動化測試

## 角色權限系統

### 支援的用戶角色

- **`user`**: 一般用戶，基本權限

  - 個人資料管理
  - 密碼變更
  - 查看個人資訊

- **`admin`**: 管理員，管理用戶權限

  - 用戶管理 (查看、編輯、刪除)
  - 創建新用戶
  - 重設用戶密碼
  - 查看用戶列表

- **`super_admin`**: 超級管理員，所有權限
  - 所有管理員權限
  - 系統管理功能
  - 管理員管理
  - 系統設定

### 登入角色隔離機制

#### 安全設計原則

- **用戶登入 API** (`/api/v1/auth/login`) 只允許 `role = 'user'` 的用戶
- **管理員登入 API** (`/api/v1/auth/admin-login`) 只允許 `role = 'admin'` 或 `'super_admin'` 的用戶
- **互相隔離**: 用戶和管理員無法使用對方的登入 API
- **軟刪除檢查**: 被軟刪除的用戶無法登入任何 API

#### 安全日誌記錄

- **成功登入記錄**: 記錄用戶 ID、IP 位址、時間戳
- **失敗登入記錄**: 記錄嘗試的用戶名、失敗原因、IP 位址
- **詳細錯誤分類**: 區分用戶不存在、密碼錯誤、角色不符等不同情況

## Email 驗證控制

### 環境變數控制

```bash
# .env 設定
REQUIRE_EMAIL_VERIFICATION=true   # 需要驗證 (預設)
REQUIRE_EMAIL_VERIFICATION=false  # 不需要驗證
```

### 驗證行為

- **一般用戶**: 受 `REQUIRE_EMAIL_VERIFICATION` 設定影響
- **管理員**: 始終不受此設定影響，可直接登入
- **註冊後狀態**: 根據設定決定是否需要驗證才能登入

### 驗證方式

- **POST API**: `/api/v1/auth/verify-email` (推薦，符合 RESTful 原則)
- **GET 連結**: `/api/email/verify/{id}/{hash}` (向下相容)

## 統一驗證規則系統

### UserValidationRules Trait

- **集中化管理**: 所有驗證規則統一管理
- **彈性組合**: 支援不同場景的規則組合
- **重複檢查**: 自動檢查 username 和 email 的唯一性

### ApiResponseFormat Trait

- **統一回應格式**: 所有 API 回應結構一致
- **錯誤處理**: 標準化的錯誤回應格式
- **狀態碼統一**: 一致的 HTTP 狀態碼使用

## 安全特色

### 密碼安全

- **強度要求**: 最少 8 字符，需包含大小寫字母及數字
- **Hash 保護**: 使用 Laravel 的 Hash facade 安全存儲
- **重設機制**: 安全的密碼重設流程

### API 安全

- **速率限制**: 防止暴力破解攻擊
- **Token 管理**: 安全的 API token 生成和管理
- **權限控制**: 基於角色的存取控制 (RBAC)
- **輸入驗證**: 所有輸入資料經過嚴格驗證

### 系統安全

- **軟刪除**: 用戶數據的安全刪除機制
- **審計追蹤**: 管理員操作的完整記錄
- **環境隔離**: 開發、測試、生產環境分離

## 開發者友善特色

### 測試驅動開發

- **TDD 方法**: 採用測試驅動開發方式
- **完整測試套件**: 170+ 自動化測試
- **多層測試**: 單元測試、功能測試、整合測試
- **手動測試腳本**: 互動式測試工具

### 開發工具

- **Docker 支援**: Laravel Sail 開發環境
- **API 文檔**: Swagger UI 即時文檔
- **郵件測試**: MailHog 郵件預覽
- **資料庫管理**: Adminer 資料庫工具

### 程式碼品質

- **PSR 標準**: 遵循 PHP 編碼標準
- **型別提示**: 完整的型別宣告
- **文檔註解**: 詳細的程式碼註解
- **錯誤處理**: 完善的例外處理機制
